```{r restore-data}
# fin1 <- openxlsx::read.xlsx(xlsxFile = "../data/sample.xlsx")
# fin2 <- openxlsx::read.xlsx(xlsxFile = "../data/financials.xlsx")
# genres <- openxlsx::read.xlsx(xlsxFile = "../data/genres.xlsx")
# save(fin1, file = "../data/fin1.Rdata")
# save(fin2, file = "../data/fin2.Rdata")
# save(genres, file = "../data/genres.Rdata")
```


```{r load-data}
rerun <- FALSE
load("../data/movies.Rdata")
load("../data/fin1.Rdata")
load("../data/fin2.Rdata")
```

```{r preprocess}
# dataSets  <- preprocess(movies, fin1, fin2)
# train <- dataSets$train
# test <- dataSets$test
# case <- dataSets$case
# mdb2 <- dataSets$mdb2
# save(train, file = "../data/train.RData")
# save(test, file = "../data/test.RData")
# save(case, file = "../data/case.RData")
# save(mdb2, file = "../data/mdb2.RData")
# rerun <- TRUE
```

```{r reload-data}
load("../data/train.Rdata")
load("../data/test.Rdata")
load("../data/case.Rdata")
load("../data/mdb2.Rdata")
all <- rbind(train, test)
```


# Part 2: Data
The data were comprised of audience and critics opinions, actor, director, and studio information, as well as notable academy award nominations and winnings, for a random sample of 651 movies obtained from the IMDB.com, Rottentomatoes.com, and BoxOfficeMojo.com websites. To relate the available features to box office success, box office revenue was obtained for a random sample of `r length(complete.cases(all))` films from The Numbers website.

## Data Sources
Launched in October 1990 by Col Needham, the Internet Movie Database (abbreviated IMDb) is an online database of film information, audience and critics ratings, plot summaries and reviews.  As of November 2017, the site contained over 4.6 million titles, 8.2 million personalities, and hosts 80 million registered users [@Wikipedia].  Rottentomatoes.com, so named from the practice of audiences throwing rotten tomatoes when disapproving of a poor stage performance, was launched officially in April 2000 by Berkeley student, Senh Duong. It provides audience and critics ratings  for some 26 million users worldwide [@Flixter]. Box Office Mojo was founded in 1999 tracks box office information and publishes it on its site [@Fritz2008]. The Numbers website, provided by Nash Information Services, compiles statistics for the movie industry [@Services2014].

## Generalizability & Causality
The data was **randomly sampled** from available IMDb and Rotten Tomatoes website apis, and so the inference *should* be generalizable to the population. However, a priori minimum sample size calculation was conducted over the proportions of films by genre. Frequency counts by genre were obtained for 6 million movies from the IMDb website [@IMDbstats2015].

`r kfigr::figr(label = "sampleSize", prefix = TRUE, link = TRUE, type="Table")`: Sample size analysis of proportions by genre
```{r sampleSize}
# Determine effect size
genres <- openxlsx::read.xlsx(xlsxFile = '../data/genres.xlsx')
ss <- sampleSize(movies, genres)
knitr::kable(ss$genres, digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")
```
As indicated in `r kfigr::figr(label = "sampleSize", prefix = TRUE, link = TRUE, type="Table")`, the minimum required sample sizes were not met for most of the genres, according to the proportions obtained from IMDb. This could reduce generalizability of models that include genre as a predictor. Since this was an observational study, random assignment was not performed, as such **causality is not indicated by this analysis**.


## Data Preprocessing
As a first step, observations for TV movies were removed as they were out of the scope of this analysis. Lacking the minimum observations for this categorical level, NC-17 films were also removed from the data.  for lack Lacking a minimum of 5 observations for this categorical level, NC-17 films were removed. Log transformations were applied to the imdb_num_votes, runtime, and box_office variables. 

**Cast Scores Variable**
A new variable was created to characterize the popularity of the cast for a film. Cast score was computed as follows:  
$$cs_i = [\displaystyle\sum_{a=1}^5 \displaystyle\sum_{f_a=1}^n s_{f_a} * p_a] - s_i $$
where:  
$cs_i$ is the cast score for film $i$  
$a$ is the variable containing the five credited actors   
$f_a$ is the film in which actor was credited  
$n$ is the number of films in which the actor was credited  
$s_{f_a}$ is the total score for film $f_a$, computed as (10 * imdb_rating) + audience score  
$p_a$ is the proportion of $s_{f_a}$ allocated to actor $a$ and is defined as:   
Actor 1: .40 * $s_{f_a}$  
Actor 1: .30 * $s_{f_a}$  
Actor 1: .15 * $s_{f_a}$  
Actor 1: .10 * $s_{f_a}$  
Actor 1: .05 * $s_{f_a}$  
$s_i$ is the total score for film $i$

Essentially, actors are allocated a proportion of the total score for each film according to the proportions above. The cast score for film $i$ is the sum of the apportioned scores for each actor minus the total score for the current film.

**Variables Removed**  
Qualitative variables with fewer than 5 observations per level were removed. This included:  
* film title 
* the url addresses  
* studio, actor and director variables  

Variables containing redundant or unrelated information were removed, such as :  
* dvd release dates, theatre release year and day   
* critics rating, redundant with critics score   
* audience rating, redndant with audience score  

The full resultant codebook for the data set is listed in `r kfigr::figr(label = "codebook", prefix = TRUE, link = TRUE, type="Table")`.

`r kfigr::figr(label = "codebook", prefix = TRUE, link = TRUE, type="Table")`: Movie data set codebook
```{r codebook}
codebook <- openxlsx::read.xlsx("../data/features.xlsx", sheet = 1)
codebook <- codebook %>% filter(final == "yes") %>% select(Type, Variable, Description) %>% arrange(Type, Variable)
knitr::kable(codebook, align = 'l') %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center") 
```

Lastly, the data was split into a training set (80%) and a test set (20%). The following exploratory data analysis and modeling was performed on the training set.

* * *
