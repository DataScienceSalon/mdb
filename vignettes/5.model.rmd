# Part 5: Modeling
At this stage, several linear regression models, based upon forward selection and backward elimination methods, were developed and evaluated to predict the popularity of a film. Popularity was defined in terms of box office success. Through statistical analysis the log of the number of IMDB votes was the best predictor of box office success, as such this was the response variable. The models and their model selection methods are: 
```{r models}
models <- openxlsx::read.xlsx(xlsxFile = "../data/models.xlsx")
knitr::kable(models, digits = 2) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")
```
`r kfigr::figr(label = "models", prefix = TRUE, link = TRUE, type="Table")`: Prediction Models

## Model Selection
Both forward selection and backward elimination with p-values model selection techniques were used. The forward selection approach optimized adjusted r-squared; whereas the backward elimination method was based upon p-values.

### Forward Selection
The forward selection process began with a null model then all variables were added to the model, one-by-one, and the model which provided the greatest improvement over the current best adjusted R-squared was selected. The process repeated with each variable that was not already in the model until all variables were analyzed. Only the models that improved adjusted r-squared were retained at each step. 

### Backward Elimination
The backward elimination approach began with the full model. A regression analysis was performed and the least significant predictor (that with the highest p-value) was removed from the model.  This process repeated, removing only the most least significant predictor at each step, until all predictors had p-values below the present threshold.   


## Full Model Selection
In the prior section, association and correlation tests were conducted with a 95% confidence level. All categorical variables were significant (`r kfigr::figr(label = "association", prefix = TRUE, link = TRUE, type="Table")`) and were included in the full model. The decision to remove a quantitative variable was based largely upon its correlation with the response variable  (`r kfigr::figr(label = "correlate", prefix = TRUE, link = TRUE, type="Table")`) and its correlations with other quantitative variables (`r kfigr::figr(label = "cMatrix", prefix = TRUE, link = TRUE, type="Table")`). `r kfigr::figr(label = "removed", prefix = TRUE, link = TRUE, type="Table")` lists the variables removed and the rationale.

`r kfigr::figr(label = "removed", prefix = TRUE, link = TRUE, type="Table")`: Variables excluded from full model
```{r removed}
removed <- openxlsx::read.xlsx("../data/features.xlsx")
removed <- removed  %>% filter(model == "no") %>% select(Type, Variable, Description, Rationale) %>% arrange(Type, Variable)
knitr::kable(removed, digits = 2) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")     
```


Thus, the full model is presented in `r kfigr::figr(label = "fullModel", prefix = TRUE, link = TRUE, type="Table")`.
```{r fullModel}
full <- openxlsx::read.xlsx("../data/features.xlsx")
full <- full  %>% filter(model == "yes") %>% select(Type, Variable, Description) %>% arrange(Type, Variable)
knitr::kable(full, digits = 2) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")     
```


## Model Alpha
For this model, a forward selection procedure was undertaken based upon the full model described above. The variables were added as described in  `r kfigr::figr(label = "forward", prefix = TRUE, link = TRUE, type="Table")`.

`r kfigr::figr(label = "model_a", prefix = TRUE, link = TRUE, type="Table")`: Model Alpha
```{r model_a, results = "html"}
# Obtain Data
mData <- process(mdb, "imdb_num_votes_log")  

# Perform forward selection
m <- forward(mData$full, y = "imdb_num_votes_log", mName = "Model Alpha")

# Conduct regression analysis
modelA <- regressionAnalysis(m, mName = "Model Alpha", yVar  = 'imdb_num_votes_log',
                               yLab = "Log IMDB Votes")

# Report regression stesp
knitr::kable(m$build, digits = 2) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")
```
`r kfigr::figr(label = "forward", prefix = TRUE, link = TRUE, type="Table")` Forward Selection Process


### Model Overview
```{r features}
features <- openxlsx::read.xlsx("../data/features.xlsx")
features <- features %>% filter(model == "yes") %>% select(Variable, Description) 
selected <- data.frame(Variable = modelA$build$Selected)
selected <- selected %>% inner_join(features)
```
This model is defined as follows:
$$y_i = (\beta_0 + \beta_1 x_{i1} + \beta_2 x_{i2} + \beta_3 x_{i3} + \beta_4 x_{i4} + \beta_5 x_{i5}) + \epsilon_i$$

where:  
$y_i$ is the log number of votes for movie $i$   
$x_{i1}$ is `r tolower(selected$Description[1])` for moving $i$   
$x_{i2}$ is `r tolower(selected$Description[2])` for moving $i$   
$x_{i3}$ is `r tolower(selected$Description[3])` for moving $i$   
$x_{i4}$ is `r tolower(selected$Description[4])` for moving $i$   
$x_{i5}$ is `r tolower(selected$Description[5])` for moving $i$    
$\epsilon_i$ is the total residual for the model for movie$i$    

```{r modelA_regression}
modelA$plots$regression
```
`r kfigr::figr(label = "modelA_regression", prefix = TRUE, link = TRUE, type="Figure")` Model Alpha Regression

The model graphically presented in `r kfigr::figr(label = "modelA_regression", prefix = TRUE, link = TRUE, type="Figure")` `r modelA$comment$apa`

`r kfigr::figr(label = "modelA_coefficients", prefix = TRUE, link = TRUE, type="Table")` Model Alpha Coefficients
```{r modelA_coefficients}
knitr::kable(modelA$summary$coefficients, digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")
```
As shown in `r kfigr::figr(label = "modelA_summary", prefix = TRUE, link = TRUE, type="Table")`, the predicted log of the number of IMDB votes per day for a film was `r round(modelA$summary$coefficients[1,1], 3)` + a genre factor associated with the genre of the film + an MPAA rating factor associated with its rating + `r round(modelA$summary$coefficients[17, 1], 3)` votes for each minute of runtime + `r round(modelA$summary$coefficients[nrow(modelA$summary$coefficients), 1], 3)` votes for each log number of films directed by the director of that film. All predictors were significant.

### Model Diagnostics
#### Linearity
The linearity of each predictor with the log number of IMDB votes is illustrated in `r kfigr::figr(label = "modelA_linearity", prefix = TRUE, link = TRUE, type="Figure")`.  

```{r modelA_linearity, fig.height=20}
gridExtra::grid.arrange(gridExtra::arrangeGrob(modelA$plots$linearity[[1]],
                                                modelA$plots$linearity[[2]],
                                                modelA$plots$linearity[[3]], ncol = 3),
                         gridExtra::arrangeGrob(modelA$plots$linearity[[4]],
                                                modelA$plots$linearity[[5]], ncol = 2),
                         nrow = 2)
                    

```
`r kfigr::figr(label = "modelA_linearity", prefix = TRUE, link = TRUE, type="Figure")` Model Alpha linearity plots

`r modelA$comment$linearity`

#### Homoscedasticity
The following plot (`r kfigr::figr(label = "modelA_homoscedasticity", prefix = TRUE, link = TRUE, type="Figure")`) of the residuals versus the fitted values provides a graphic indication of the distribution of residual variances. 
```{r modelA_homoscedasticity}
modelA$plots$res_fitted
```
`r kfigr::figr(label = "modelA_homoscedasticity", prefix = TRUE, link = TRUE, type="Figure")` Model Alpha homoscedasticity plot

`r modelA$comments$homoscedasticity`

#### Residuals
The histogram and the normal Q-Q plot in `r kfigr::figr(label = "modelA_residuals", prefix = TRUE, link = TRUE, type="Figure")` illustrate the distribution of residuals.

```{r modelA_residuals}
gridExtra::grid.arrange(modelA$plots$res_hist, modelA$plots$res_qq, ncol = 2)
                        

```
`r kfigr::figr(label = "modelA_residuals", prefix = TRUE, link = TRUE, type="Figure")` Model Alpha residuals plot

`r modelA$comments$normality`

#### Multicollinearity
As shown in `r kfigr::figr(label = "modelA_multicollinearity", prefix = TRUE, link = TRUE, type="Figure")` and `r kfigr::figr(label = "modelA_vif", prefix = TRUE, link = TRUE, type="Table")`, `r modelA$comments$collinearity`
```{r modelA_multicollinearity}
modelA$plots$multicollinearity$plot()
```
`r kfigr::figr(label = "modelA_multicollinearity", prefix = TRUE, link = TRUE, type="Figure")`: Model Alpha correlations among quantitative predictors 

`r kfigr::figr(label = "modelA_vif", prefix = TRUE, link = TRUE, type="Table")` Model Alpha Variance Inflation Factors
```{r modelA_vif}
knitr::kable(modelA$tests$collinearity, digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")
```


#### Outliers
```{r modelA_outliers}
gridExtra::grid.arrange(modelA$plots$res_leverage, modelA$plots$cooks, ncol = 2)
```
`r kfigr::figr(label = "modelA_outliers", prefix = TRUE, link = TRUE, type="Table")` Model Alpha Outliers

`r modelA$comments$outliers`

## Model Beta
For this model, a forward selection procedure was undertaken based upon the full model with outliers from Model Beta removed. The variables were added as described in  `r kfigr::figr(label = "forward", prefix = TRUE, link = TRUE, type="Table")`.

`r kfigr::figr(label = "model_b", prefix = TRUE, link = TRUE, type="Table")`: Model Beta
```{r model_b, results = "html"}
# Obtain Data
mData <- process(mdb, "imdb_num_votes_log", outliers = modelA$tests$influential)  

# Perform forward selection
m <- forward(mData$full, y = "imdb_num_votes_log", mName = "Model Beta")

# Conduct regression analysis
modelB <- regressionAnalysis(m, mName = "Model Beta", yVar  = 'imdb_num_votes_log',
                               yLab = "Log IMDB Votes")

# Report regression stesp
knitr::kable(m$build, digits = 2) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")
```
`r kfigr::figr(label = "forward", prefix = TRUE, link = TRUE, type="Table")` Forward Selection Process


### Model Overview
```{r features_b}
features <- openxlsx::read.xlsx("../data/features.xlsx")
features <- features %>% filter(model == "yes") %>% select(Variable, Description) 
selected <- data.frame(Variable = modelB$build$Selected)
selected <- selected %>% inner_join(features)
```
This model is defined as follows:
$$y_i = (\beta_0 + \beta_1 x_{i1} + \beta_2 x_{i2} + \beta_3 x_{i3} + \beta_4 x_{i4} + \beta_5 x_{i5}) + \epsilon_i$$

where:  
$y_i$ is the log number of votes for movie $i$   
$x_{i1}$ is `r tolower(selected$Description[1])` for moving $i$   
$x_{i2}$ is `r tolower(selected$Description[2])` for moving $i$   
$x_{i3}$ is `r tolower(selected$Description[3])` for moving $i$   
$x_{i4}$ is `r tolower(selected$Description[4])` for moving $i$   
$x_{i5}$ is `r tolower(selected$Description[5])` for moving $i$    
$\epsilon_i$ is the total residual for the model for movie$i$    

```{r modelB_regression}
modelB$plots$regression
```
`r kfigr::figr(label = "modelB_regression", prefix = TRUE, link = TRUE, type="Figure")` Model Beta Regression

The model graphically presented in `r kfigr::figr(label = "modelB_regression", prefix = TRUE, link = TRUE, type="Figure")` `r modelB$comment$apa`

`r kfigr::figr(label = "modelB_coefficients", prefix = TRUE, link = TRUE, type="Table")` Model Beta Coefficients
```{r modelB_coefficients}
knitr::kable(modelB$summary$coefficients, digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")
```
As shown in `r kfigr::figr(label = "modelB_summary", prefix = TRUE, link = TRUE, type="Table")`, the predicted log of the number of IMDB votes per day for a film was `r round(modelB$summary$coefficients[1,1], 3)` + a genre factor associated with the genre of the film + an MPAA rating factor associated with its rating + `r round(modelB$summary$coefficients[17, 1], 3)` votes for each minute of runtime + `r round(modelB$summary$coefficients[nrow(modelB$summary$coefficients), 1], 3)` votes for each log number of films directed by the director of that film. All predictors were significant.

### Model Diagnostics
#### Linearity
The linearity of each predictor with the log number of IMDB votes is illustrated in `r kfigr::figr(label = "modelB_linearity", prefix = TRUE, link = TRUE, type="Figure")`.  

```{r modelB_linearity, fig.height=20}
gridExtra::grid.arrange(gridExtra::arrangeGrob(modelB$plots$linearity[[1]],
                                                modelB$plots$linearity[[2]],
                                                modelB$plots$linearity[[3]], ncol = 3),
                         gridExtra::arrangeGrob(modelB$plots$linearity[[4]],
                                                modelB$plots$linearity[[5]], ncol = 2),
                         nrow = 2)
                    

```
`r kfigr::figr(label = "modelB_linearity", prefix = TRUE, link = TRUE, type="Figure")` Model beta linearity plots

`r modelB$comment$linearity`

#### Homoscedasticity
The following plot (`r kfigr::figr(label = "modelB_homoscedasticity", prefix = TRUE, link = TRUE, type="Figure")`) of the residuals versus the fitted values provides a graphic indication of the distribution of residual variances. 
```{r modelB_homoscedasticity}
modelB$plots$res_fitted
```
`r kfigr::figr(label = "modelB_homoscedasticity", prefix = TRUE, link = TRUE, type="Figure")` Model beta homoscedasticity plot

`r modelB$comments$homoscedasticity`

#### Residuals
The histogram and the normal Q-Q plot in `r kfigr::figr(label = "modelB_residuals", prefix = TRUE, link = TRUE, type="Figure")` illustrate the distribution of residuals.

```{r modelB_residuals}
gridExtra::grid.arrange(modelB$plots$res_hist, modelB$plots$res_qq, ncol = 2)
                        

```
`r kfigr::figr(label = "modelB_residuals", prefix = TRUE, link = TRUE, type="Figure")` Model beta residuals plot

`r modelB$comments$normality`

#### Multicollinearity
As shown in `r kfigr::figr(label = "modelB_multicollinearity", prefix = TRUE, link = TRUE, type="Figure")` and `r kfigr::figr(label = "modelB_vif", prefix = TRUE, link = TRUE, type="Table")`, `r modelB$comments$collinearity`
```{r modelB_multicollinearity}
modelB$plots$multicollinearity$plot()
```
`r kfigr::figr(label = "modelB_multicollinearity", prefix = TRUE, link = TRUE, type="Figure")`: Correlations among quantitative predictors 

`r kfigr::figr(label = "modelB_vif", prefix = TRUE, link = TRUE, type="Table")` Model Beta Variance Inflation Factors
```{r modelB_vif}
knitr::kable(modelB$tests$collinearity, digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("hover", "condensed", "responsive"), full_width = T, position = "center")
```


#### Outliers
```{r modelB_outliers}
gridExtra::grid.arrange(modelB$plots$res_leverage, modelB$plots$cooks, ncol = 2)
```
`r kfigr::figr(label = "modelB_outliers", prefix = TRUE, link = TRUE, type="Table")` Model Beta Outliers

`r modelB$comments$outliers`





* * *
